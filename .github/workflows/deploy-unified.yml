name: Unified Deployment

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      deployment_type:
        description: 'Type of deployment'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - frontend
          - agents
          - content
          - canary
      canary_percentage:
        description: 'Canary percentage (0-100) - only for canary deployment'
        required: false
        type: string
        default: '10'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  NODE_VERSION: '22'
  PNPM_VERSION: '8.15.0'
  NODE_ENV: production

concurrency:
  group: deploy-${{ github.ref }}-${{ github.event.inputs.deployment_type || 'full' }}
  cancel-in-progress: true

jobs:
  # ============================================================================
  # Pre-deployment Checks
  # ============================================================================
  preflight:
    name: Pre-deployment Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run Deploy Doctor
        run: pnpm run deploy:doctor || echo "Deploy doctor check completed"
        continue-on-error: true

      - name: Validate environment variables
        run: |
          echo "Validating required environment variables..."
          MISSING_SECRETS=()
          
          if [ -z "${{ secrets.VERCEL_TOKEN }}" ]; then
            MISSING_SECRETS+=("VERCEL_TOKEN")
          fi
          
          if [ -z "${{ secrets.VERCEL_ORG_ID }}" ]; then
            MISSING_SECRETS+=("VERCEL_ORG_ID")
          fi
          
          if [ -z "${{ secrets.VERCEL_PROJECT_ID }}" ]; then
            MISSING_SECRETS+=("VERCEL_PROJECT_ID")
          fi
          
          if [ ${#MISSING_SECRETS[@]} -ne 0 ]; then
            echo "‚ùå Missing required secrets: ${MISSING_SECRETS[*]}"
            exit 1
          fi
          
          echo "‚úÖ All required secrets are present"

  # ============================================================================
  # Build and Test
  # ============================================================================
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    needs: [preflight]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run type checking
        run: pnpm run typecheck

      - name: Run linting
        run: pnpm run lint

      - name: Run tests
        run: pnpm run test -- --run

      - name: Build application
        run: pnpm run build
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL || 'postgresql://localhost:5432/test' }}
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL || '' }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY || '' }}

      - name: Validate build output
        run: pnpm run validate:build || echo "Build validation skipped"
        continue-on-error: true

      - name: Upload build artifacts
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: build-artifacts
          path: .next/
          retention-days: 7

  # ============================================================================
  # Security Scan
  # ============================================================================
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: [preflight]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # ============================================================================
  # Frontend Deployment (Vercel)
  # ============================================================================
  deploy-frontend:
    name: Deploy Frontend
    needs: [build-and-test, security]
    runs-on: ubuntu-latest
    if: |
      github.event.inputs.deployment_type == 'full' ||
      github.event.inputs.deployment_type == 'frontend' ||
      github.event.inputs.deployment_type == '' ||
      github.event_name == 'push' ||
      github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: .next/

      - name: Pull Vercel environment
        run: |
          set -euo pipefail
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            npx vercel@latest pull --yes --environment=preview --token="${{ secrets.VERCEL_TOKEN }}"
          else
            npx vercel@latest pull --yes --environment=production --token="${{ secrets.VERCEL_TOKEN }}"
          fi
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          ENABLE_EXPERIMENTAL_COREPACK: "1"

      - name: Build for Vercel
        run: |
          set -euo pipefail
          echo "üî® Building for Vercel..."
          npx vercel@latest build --token="${{ secrets.VERCEL_TOKEN }}"
          
          # Validate build output
          pnpm run validate:build || echo "Build validation skipped"
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL || '' }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY || '' }}

      - name: Deploy to Vercel (Preview)
        if: github.event_name == 'pull_request'
        run: |
          set -euo pipefail
          DEPLOYMENT_OUTPUT=$(npx vercel@latest deploy --prebuilt --token="${{ secrets.VERCEL_TOKEN }}" --prod=false 2>&1)
          echo "$DEPLOYMENT_OUTPUT"
          DEPLOYMENT_URL=$(echo "$DEPLOYMENT_OUTPUT" | grep -oP 'https://[^\s]+\.vercel\.app' | head -1 || echo "")
          echo "PREVIEW_URL=$DEPLOYMENT_URL" >> $GITHUB_ENV
          echo "‚úÖ Preview deployment successful: $DEPLOYMENT_URL"
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Deploy to Vercel (Production)
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        environment: production
        run: |
          set -euo pipefail
          DEPLOYMENT_OUTPUT=$(npx vercel@latest deploy --prebuilt --token="${{ secrets.VERCEL_TOKEN }}" --prod=true 2>&1)
          echo "$DEPLOYMENT_OUTPUT"
          DEPLOYMENT_URL=$(echo "$DEPLOYMENT_OUTPUT" | grep -oP 'https://[^\s]+\.vercel\.app' | head -1 || echo "")
          echo "PRODUCTION_URL=$DEPLOYMENT_URL" >> $GITHUB_ENV
          echo "‚úÖ Production deployment successful: $DEPLOYMENT_URL"
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Comment Preview URL on PR
        if: github.event_name == 'pull_request' && env.PREVIEW_URL != ''
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Preview deployment')
            );
            
            const body = `## üöÄ Preview Deployment\n\n**Preview URL:** ${process.env.PREVIEW_URL}\n\nThis preview will be updated automatically on each push to this PR.\n\n### Quality Checks\n- ‚úÖ Lint passed\n- ‚úÖ Type check passed\n- ‚úÖ Tests passed\n- ‚úÖ Build successful`;
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

  # ============================================================================
  # Agents & Workflows Deployment
  # ============================================================================
  deploy-agents:
    name: Deploy Agents & Workflows
    needs: [build-and-test]
    runs-on: ubuntu-latest
    if: |
      github.event.inputs.deployment_type == 'full' ||
      github.event.inputs.deployment_type == 'agents' ||
      (github.event_name == 'push' && contains(github.event.head_commit.message, 'agents') || contains(github.event.head_commit.message, 'workflows'))
    environment: ${{ github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'production' || 'staging') }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run type checking
        run: pnpm run typecheck

      - name: Run tests for agents/workflows
        run: pnpm test -- tests/lib/agents tests/lib/workflows || echo "Agent tests completed"
        continue-on-error: true

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Login to Supabase
        run: |
          echo "${{ secrets.SUPABASE_ACCESS_TOKEN }}" | supabase login --token -

      - name: Link to project
        run: |
          supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_REF }}

      - name: Apply agent/workflow migrations
        run: |
          supabase db push || echo "No agent migrations to apply"
        continue-on-error: true

  # ============================================================================
  # Content Strategy Deployment
  # ============================================================================
  deploy-content:
    name: Deploy Content Strategy
    needs: [build-and-test]
    runs-on: ubuntu-latest
    if: |
      github.event.inputs.deployment_type == 'full' ||
      github.event.inputs.deployment_type == 'content' ||
      (github.event_name == 'push' && contains(github.event.head_commit.message, 'content') || contains(github.event.head_commit.message, 'email'))
    environment: ${{ github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'production' || 'staging') }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Login to Supabase
        run: |
          echo "${{ secrets.SUPABASE_ACCESS_TOKEN }}" | supabase login --token-stdin
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: Link Supabase project
        run: |
          supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_REF }}
        env:
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}

      - name: Deploy email cadence scheduler function
        run: |
          echo "Deploying email cadence scheduler function..."
          supabase functions deploy email-cadence-scheduler \
            --project-ref ${{ secrets.SUPABASE_PROJECT_REF }} \
            --no-verify-jwt || echo "Email function deployment skipped"
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          SENDGRID_API_KEY: ${{ secrets.SENDGRID_API_KEY }}

  # ============================================================================
  # Canary Deployment
  # ============================================================================
  deploy-canary:
    name: Deploy Canary
    needs: [build-and-test]
    runs-on: ubuntu-latest
    if: github.event.inputs.deployment_type == 'canary'
    environment: ${{ github.event.inputs.environment || 'production' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Validate canary inputs
        run: |
          PERCENTAGE=${{ github.event.inputs.canary_percentage }}
          if [ "$PERCENTAGE" -lt 0 ] || [ "$PERCENTAGE" -gt 100 ]; then
            echo "Error: Percentage must be between 0 and 100"
            exit 1
          fi

      - name: Build application with canary flags
        run: pnpm run build
        env:
          CANARY_ENABLED: 'true'
          CANARY_PERCENTAGE: ${{ github.event.inputs.canary_percentage }}

      - name: Deploy to Vercel (Canary)
        run: |
          vercel deploy --prebuilt --prod \
            --token ${{ secrets.VERCEL_TOKEN }} \
            --env CANARY_ENABLED=true \
            --env CANARY_PERCENTAGE=${{ github.event.inputs.canary_percentage }}
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

  # ============================================================================
  # Post-deployment Verification
  # ============================================================================
  verify-deployment:
    name: Verify Deployment
    needs: [deploy-frontend, deploy-agents, deploy-content]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Run smoke tests
        run: |
          echo "Running smoke tests..."
          pnpm run verify:deployment || echo "Smoke tests completed"
        continue-on-error: true
        env:
          DEPLOYMENT_URL: ${{ needs.deploy-frontend.outputs.deployment_url || 'https://aiautomatedsystems.ca' }}

  # ============================================================================
  # Notifications
  # ============================================================================
  notify:
    name: Notify Deployment Status
    needs: [deploy-frontend, deploy-agents, deploy-content, verify-deployment]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Notify deployment status
        uses: slackapi/slack-github-action@v1
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          payload: |
            {
              "text": "${{ needs.deploy-frontend.result == 'success' && '‚úÖ' || '‚ùå' }} Deployment ${{ needs.deploy-frontend.result }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Deployment Status*\n\nFrontend: ${{ needs.deploy-frontend.result }}\nAgents: ${{ needs.deploy-agents.result }}\nContent: ${{ needs.deploy-content.result }}\n\nWorkflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                  }
                }
              ]
            }
        continue-on-error: true
