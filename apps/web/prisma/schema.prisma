// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider        = "prisma-client-js"
  engineType      = "library"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email     String   @unique
  name      String?
  avatar    String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Supabase auth
  supabaseId String? @unique @map("supabase_id")

  // Relations
  memberships Membership[]
  apiKeys     ApiKey[]
  aiRuns      AiRun[]
  reports     Report[]
  projects    Project[]

  @@map("users")
}

// Mapped to 'tenants' table
model Organization {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String
  slug        String   @unique
  description String?
  logo        String?
  website     String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  memberships   Membership[]
  subscriptions Subscription[]
  projects      Project[]
  sources       Source[]
  webhookEvents WebhookEvent[]
  featureFlags  FeatureFlag[]

  @@map("tenants")
}

// Mapped to 'tenant_members' table
model Membership {
  id     String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  role   String @default("viewer") // Mapped to VARCHAR
  userId String @map("user_id") @db.Uuid
  orgId  String @map("tenant_id") @db.Uuid

  user User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  org  Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  // Mapped to joined_at
  createdAt DateTime @default(now()) @map("joined_at")

  @@unique([userId, orgId])
  @@map("tenant_members")
}

model Subscription {
  id                   String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  status               SubscriptionStatus
  plan                 Plan
  stripeCustomerId     String?            @unique @map("stripe_customer_id")
  stripeSubscriptionId String?            @unique @map("stripe_subscription_id")
  stripePriceId        String?            @map("stripe_price_id")
  currentPeriodStart   DateTime?          @map("current_period_start")
  currentPeriodEnd     DateTime?          @map("current_period_end")
  cancelAtPeriodEnd    Boolean            @default(false) @map("cancel_at_period_end")
  createdAt            DateTime           @default(now()) @map("created_at")
  updatedAt            DateTime           @updatedAt @map("updated_at")

  orgId String       @map("tenant_id") @db.Uuid
  org   Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}

model ApiKey {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name      String
  key       String    @unique
  lastUsed  DateTime? @map("last_used")
  createdAt DateTime  @default(now()) @map("created_at")
  expiresAt DateTime? @map("expires_at")

  userId String @map("user_id") @db.Uuid
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("api_keys")
}

model Project {
  id          String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String
  description String?
  status      ProjectStatus @default(ACTIVE)
  metadata    Json?
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  userId String       @map("user_id") @db.Uuid
  orgId  String       @map("tenant_id") @db.Uuid

  user User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  org  Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@map("projects")
}

model Source {
  id        String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name      String
  type      SourceType
  config    Json
  lastRun   DateTime?  @map("last_run")
  isActive  Boolean    @default(true) @map("is_active")
  createdAt DateTime   @default(now()) @map("created_at")
  updatedAt DateTime   @updatedAt @map("updated_at")

  orgId String       @map("tenant_id") @db.Uuid
  org   Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  ingestEvents IngestEvent[]

  @@map("sources")
}

model IngestEvent {
  id          String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  status      IngestStatus
  stats       Json?
  error       String?
  startedAt   DateTime     @default(now()) @map("started_at")
  completedAt DateTime?    @map("completed_at")

  sourceId String @map("source_id") @db.Uuid
  source   Source @relation(fields: [sourceId], references: [id], onDelete: Cascade)

  @@map("ingest_events")
}

model Product {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String
  description String?
  price       Decimal?
  currency    String?
  category    String?
  tags        String[]
  metadata    Json?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("products")
}

model Trend {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  keyword   String
  volume    Int?
  category  String?
  region    String?
  period    String?
  metadata  Json?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("trends")
}

model Creative {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title       String
  description String?
  type        String?
  platform    String?
  metadata    Json?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("creatives")
}

model Metric {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name      String
  value     Decimal
  unit      String?
  category  String?
  metadata  Json?
  createdAt DateTime @default(now()) @map("created_at")

  @@map("metrics")
}

model AiRun {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  kind       AiRunKind
  provider   String
  model      String
  tokensIn   Int?      @map("tokens_in")
  tokensOut  Int?      @map("tokens_out")
  cost       Decimal?
  durationMs Int?      @map("duration_ms")
  metadata   Json?
  createdAt  DateTime  @default(now()) @map("created_at")

  userId String @map("user_id") @db.Uuid
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("ai_runs")
}

model Report {
  id        String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title     String
  type      ReportType
  content   Json
  status    ReportStatus @default(PENDING)
  fileUrl   String?      @map("file_url")
  metadata  Json?
  createdAt DateTime     @default(now()) @map("created_at")
  updatedAt DateTime     @updatedAt @map("updated_at")

  userId String @map("user_id") @db.Uuid
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("reports")
}

model WebhookEvent {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  source    String
  event     String
  payload   Json
  processed Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")

  orgId String       @map("tenant_id") @db.Uuid
  org   Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@map("webhook_events")
}

model FeatureFlag {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  key         String   @unique
  name        String
  description String?
  enabled     Boolean  @default(false)
  config      Json?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  orgId String       @map("tenant_id") @db.Uuid
  org   Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@map("feature_flags")
}

// Enums (Mapped to String/VARCHAR mostly, except where enum type exists)
// Keeping Prisma Enums for type safety in App Layer
enum Role {
  ADMIN
  EDITOR
  VIEWER
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  INCOMPLETE
  INCOMPLETE_EXPIRED
  PAST_DUE
  TRIALING
  UNPAID
}

enum Plan {
  FREE
  BASIC
  PRO
  ENTERPRISE
}

enum ProjectStatus {
  ACTIVE
  ARCHIVED
  COMPLETED
}

enum SourceType {
  SHOPIFY_JSON
  GOOGLE_TRENDS_CSV
  TIKTOK_BUSINESS_JSON
  ALIEXPRESS_CSV
  GENERIC_CSV
  GENERIC_JSON
}

enum IngestStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

enum AiRunKind {
  CHAT
  AUDIT
  ESTIMATE
  CONTENT_GENERATION
  WORKFLOW_GENERATION
}

enum ReportType {
  AUDIT
  ESTIMATE
  CONTENT_PLAN
  WORKFLOW
}

enum ReportStatus {
  PENDING
  GENERATING
  COMPLETED
  FAILED
}
